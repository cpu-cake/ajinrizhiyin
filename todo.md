# 硬币运势分析器 - 项目TODO

## 核心功能
- [x] 数据库schema：存储硬币投掷记录和分析结果
- [x] 后端API：接收硬币结果，调用LLM进行分析
- [x] 前端界面：硬币投掷交互和结果展示
- [x] LLM集成：调用大模型进行运势分析
- [x] 完整流程：前后端联调
- [x] 基于设备信息的每天一次投掷逻辑
- [x] 实现设备信息存储和识别
- [x] 实现每天一次的缓存逻辑
- [x] 0点后重置投掷逻辑
- [x] 移除登录系统和OAuth认证
- [x] 移除用户表，只保留设备表
- [x] 简化后端API，移除认证检查

## UI/UX
- [x] 实现硬币投掷动画
- [x] 结果加载状态和展示
- [x] 响应式设计优化
- [x] 保留原始设计的布局和动画
- [x] 隐藏硬币相关文字和投掷结果
- [x] 移除"重新投掷"按钮
- [x] 修改页面上方文字（日期和"你的今日专属指引"）
- [x] 移除登录界面和登录按钮
- [x] 所有用户都通过设备指纹识别

## 测试和部署
- [x] 编写API测试
- [x] 端到端测试
- [x] 验证新功能
- [x] 所有测试通过


## 最新改动（第二轮）
- [x] 修改启动页文案：“正在为你生成今日运势…” → “正在为你生成今日专属指引…”
- [x] 检查安卓手机浏览器适配
- [x] 优化移动端布局和交互
- [x] 测试移动端响应式设计


## 第三轮改动 - 交互动画
- [x] 为卡片添加CSS动画效果
- [x] 实现点击时的缩放动画
- [x] 实现点击时的颜色变化反馈
- [x] 测试动画效果在不同设备上的表现


## 第四轮改动 - 内容优化
- [x] 更新LLM提示词，避免使用“卤”、“卤象”、“运势”、“爬”等术语
- [x] 测试生成的内容是否包含禁用词汇
- [x] 验证所有卡片内容的合规性


## 第五轮改动 - 调试功能
- [x] 创建调试控制台组件
- [x] 实现日志记录和显示功能
- [x] 添加错误信息捕获
- [x] 集成到前端页面
- [x] 测试调试功能


## 第六轮改动 - 清理
- [x] 从 App.tsx 中移除 DebugConsole 应用
- [x] 删除 DebugConsole 组件文件


## 第七轮改动 - 配色和导航按钮
- [x] 更新各板块的配色和Material Icons图标
- [x] 在日期上方添加顶部导航按钮
- [x] 实现按钮的样式和动画效果
- [x] 测试响应式设计


## 第八轮改动 - 解答小困惑功能
- [x] 添加CSS样式到index.css
- [x] 添加HTML结构到Home.tsx（仅在日期下方）
- [x] 实现小困惑轮播逻辑
- [x] 创建后端API处理小困惑解读
- [x] 集成LLM生成解读内容
- [x] 测试功能完整性


## BUG修复 - 解答小困惑点击无反应
- [x] 检查前端点击事件绑定
- [x] 检查后端API调用路径
- [x] 修复JavaScript逻辑
- [x] 修复trpc调用方式（使用useMutation和mutateAsync）
- [ ] 测试点击功能


## 第九轮改动 - 解答小困惑功能优化
- [ ] 调整"解答小困惑"位置，向上移动避免重叠
- [ ] 添加30个新问题标签
- [ ] 实现问题标签的横向滑动功能
- [ ] 修复点击问题时的iframe嵌入错误
- [ ] 测试所有功能


## 第十一轮改动 - 标签宽度和解读位置调整
- [ ] 修改标签背景宽度为自适应（根据文字长短调节）
- [ ] 将解读内容显示在困惑标签下方和早安心语上方
- [ ] 测试功能完整性

## 第十二轮改动 - 标题栏防止选中和硬币投掷集成
- [x] 添加user-select: none样式到标题栏，防止文字选中
- [x] 修改explainQuestion API，支持coinResults参数
- [x] 将硬币结果转换为卦象描述并传给LLM
- [x] 实现点击标签时调用硬币投掷API
- [x] 验证LLM生成的解读不包含禁用词汇
- [x] 测试加载动画和内容切换
- [x] 测试所有功能完整性

## 第十三轮改动 - 修改解读提示词
- [x] 修改explainQuestion的系统提示词，改为基于六爻卦象的解读
- [x] 测试修改后的解读内容
- [x] 确保解读内容仍符合100字以内和禁用词汇要求

## 第十四轮改动 - 优化解读提示词
- [x] 修改explainQuestion的提示词，要求直白、现代、无古语
- [x] 禁用更多词汇（象、此象）
- [x] 测试修改后的解读内容

## 第十五轮改动 - 标签栏显示和使用次数限制
- [x] 调整标签栏布局，确保最右一列文字完整显示
- [x] 添加每日使用次数跟踪
- [x] 实现每天限制右次的功能
- [x] 超过3次时显示"明天再来"提示
- [x] 测试所有功能

## 第十六轮改动 - 随机提示语和突出显示
- [x] 添加随机提示语数组（分为20:00-24:00和其他时段）
- [x] 实现时间判断逻辑
- [x] 隐藏原来的解读板块
- [x] 突出显示提示语
- [x] 测试随机提示语功能

## 第十七轮改动 - 修复使用次数限制逻辑
- [x] 在coin_readings表中添加type字段区分类型（daily_fortune / question_answer）
- [x] 修改getTodaysUsageCount函数，支持按类型统计
- [x] 修改explainQuestion，只统计question_answer类型的记录
- [x] 修改createCoinReading，添加type参数
- [x] 测试前3次可以正常解答，第4次才显示提示语

## 第十八轮改动 - 优化解答小困惑UI样式
- [x] 更新question-title-bar样式，使用主题粉色背景
- [x] 修改文字颜色为白色，增强对比度
- [x] 增大图标尺寸，增强视觉引导性
- [x] 添加更明显的阴影效果，突出立体感
- [x] 测试新样式的显示效果

## 第十九轮改动 - iOS WKWebView加载性能优化
- [x] 提取关键CSS并内联到HTML的<style>标签中
- [x] 延迟加载非关键CSS（卡片样式、动画、悬停效果）
- [x] 将script标签移到body底部
- [x] 为script标签添加defer属性
- [x] 使用setTimeout延迟运势内容生成（100ms）
- [x] 测试首屏加载速度优化效果

## 第二十轮改动 - 修复交互问题、添加新标签、调整次数限制
- [x] 修复"解答小困惑"下拉/收起无反应问题
  - [x] 给question-title-bar设置较高的z-index
  - [x] 优化点击事件响应
- [x] 添加14个新标签
  - [x] 请夸我
  - [x] 求表扬
  - [x] 想听点好消息
  - [x] 好像没人懂我
  - [x] 要不要发这条朋友圈？
  - [x] 我说的这句话是不是太冒失了？
  - [x] 我是不是又搞砸了？
  - [x] 买这件东西是冲动消费吗？
  - [x] 要不要换头像？
  - [x] 要不要改昵称？
  - [x] 今天该做点什么？
  - [x] 推荐一件提升幸福感的小事
  - [x] 给个提升自我的小任务
  - [x] 今天适合发疯吗？
- [x] 标签内容分批加载，缩短首批加载时间
- [x] 修改次数限制从3次改为6次
- [x] 更新超限提示语为"问题超限，再问就要剧透宇宙奥秘了～明天继续哦！"
- [x] 修复新设备首次打开显示超限的bug
- [x] 测试所有改动

## 第二十一轮改动 - 重新排列标签为纵向6行×横向8列布局
- [x] 更新标签内容为48个新标签（8列×6行）
- [x] 修改CSS样式，实现纵向排列
- [x] 修改CSS样式，实现横向滚动
- [x] 修改标签容器布局，固定行高和间距
- [x] 标签文字左对齐、横向排列，背景自适应
- [x] 父框高度固定，可横向滑动
- [x] 测试所有改动

## 第二十二轮改动 - 改为Flexbox流式布局，实现横向错落效果
- [x] 将标签容器从Grid布局改为Flexbox布局
- [x] 使用flex-direction: column实现纵向排列
- [x] 使用flex-wrap: wrap实现自动换列
- [x] 限制容器高度，确保6行后自动换列
- [x] 标签宽度完全自适应文字内容
- [x] 实现横向错落效果（每行起始位置不对齐）
- [x] 测试横向滚动和无限拓展

## 第二十三轮改动 - 修复标签布局问题
- [x] 调整容器高度，确保每列显示6行而不是5行
- [x] 修复标签之间间距不一致的问题
- [x] 确保标签之间的间距固定（纵向和横向间距都为10px）
- [x] 测试所有改动

## 第二十四轮改动 - 真正修复标签布局问题
- [x] 增加容器高度到310px，确保每列显示6行（之前只有5行）
- [x] 使用rowGap和columnGap分别控制横向和纵向间距
- [x] 确保横向标签之间的间距固定为16px，纵向间距固定为10px
- [x] 测试验证8列×6行布局和固定间距

## 第二十五轮改动 - 优化点击响应，添加标签点击统计和热门标签徽章
- [x] 修复"解答小困惑"下拉/收起点击响应问题（需要点击多次才有反应）
- [x] 设计数据库表结构，存储标签点击统计数据
- [x] 实现标签点击记录功能（每次点击标签时记录）
- [x] 实现每日凌晨4点统计前一天最热门的5个标签
- [x] 在热门标签右上角显示🔥徽章
- [x] 处理没有昨日数据的情况（首次运行时），避免错误
- [x] 测试所有功能

## 第二十六轮改动 - 修夏LLM提示词，确保禁用词汇完整
- [x] 修夏首页早安心语的提示词，添加"象"和"此象"到禁用词汇列表
- [x] 验证解答小困惑的提示词是否包含完整的禁用词汇
- [x] 测试生成的内容是否包含禁用词汇

## 第二十七轮改动 - 修改解答小困惑API，每次点击都重新投币
- [x] 修改explainQuestion后端代码，移除使用前端传来的coinResults
- [x] 在explainQuestion中每次都重新投币（生成新的硬币结果）
- [x] 修改前端代码，移除coinResults参数传递
- [x] 测试每次点击标签都获取不同的解读

## 第二十八轮改动 - 添加调试日志和优化小困惑提示词
- [x] 在routers.ts第149行之前添加调试日志，打印每次生成的硬币结果
- [x] 修改小困惑提示词，改为更温暖、鼓励的版本
- [x] 移除100字限制，允许更个性化的分析
- [x] 测试验证连续点击同一标签时硬币结果是否不同

## 第二十九轮改动 - 纠正代码中的错别字
- [x] 修复explainQuestion中的错别字：“爼”改为“爼”，“卢”改为“卢”
- [x] 修复performNewToss中的错别字：“爼”改为“爼”，“卢”改为“卢”

## 第三十轮改动 - 标签收起时同步收起回答框
- [x] 检查当前的下拉/收起逻辑
- [x] 修改代码，让标签收起时清空回答框内容
- [x] 测试验证功能
